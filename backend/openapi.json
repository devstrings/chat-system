{
  "openapi": "3.0.0",
  "info": {
    "title": "Chat API",
    "version": "1.0.0",
    "description": "API documentation for auth, users, messages (conversations), and file upload/download.",
    "contact": {
      "name": "API Support",
      "email": "support@example.com"
    },
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    }
  },
  "servers": [
    {
      "url": "http://localhost:5000/api",
      "description": "Local Development Server"
    },
    {
      "url": "https://api.yourapp.com/api",
      "description": "Production Server"
    }
  ],
  "security": [
    {
      "BearerAuth": []
    }
  ],
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Enter JWT token in format: Bearer <token>"
      }
    },
    "schemas": {
      "RegisterRequest": {
        "type": "object",
        "properties": {
          "username": { 
            "type": "string", 
            "example": "ahmed123",
            "minLength": 3,
            "maxLength": 20,
            "description": "Unique username"
          },
          "email": { 
            "type": "string", 
            "format": "email", 
            "example": "ahmed@example.com" 
          },
          "password": { 
            "type": "string", 
            "example": "P@ssw0rd",
            "minLength": 6,
            "description": "Minimum 6 characters"
          }
        },
        "required": ["username", "email", "password"]
      },
      "LoginRequest": {
        "type": "object",
        "properties": {
          "email": { 
            "type": "string", 
            "format": "email", 
            "example": "ahmed@example.com" 
          },
          "password": { 
            "type": "string", 
            "example": "P@ssw0rd" 
          }
        },
        "required": ["email", "password"]
      },
      "AuthResponse": {
        "type": "object",
        "properties": {
          "token": { 
            "type": "string", 
            "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
            "description": "JWT authentication token"
          },
          "user": { "$ref": "#/components/schemas/UserFull" }
        }
      },
      "UserMinimal": {
        "type": "object",
        "description": "Minimal user object for privacy (only username and _id exposed)",
        "properties": {
          "_id": { 
            "type": "string", 
            "example": "507f1f77bcf86cd799439011",
            "description": "Unique user identifier"
          },
          "username": { 
            "type": "string", 
            "example": "ahmed123",
            "description": "Username"
          }
        }
      },
      "UserFull": {
        "type": "object",
        "description": "Full user object (returned on login/register)",
        "properties": {
          "_id": { 
            "type": "string", 
            "example": "507f1f77bcf86cd799439011"
          },
          "username": { 
            "type": "string", 
            "example": "ahmed123" 
          },
          "email": { 
            "type": "string", 
            "format": "email", 
            "example": "ahmed@example.com" 
          },
          "avatar": { 
            "type": "string", 
            "nullable": true,
            "example": "https://res.cloudinary.com/xxx/avatar.jpg" 
          },
          "bio": {
            "type": "string",
            "nullable": true,
            "example": "Software Developer"
          },
          "isOnline": {
            "type": "boolean",
            "example": true
          },
          "lastSeen": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "createdAt": { 
            "type": "string", 
            "format": "date-time",
            "example": "2024-01-15T10:30:00Z"
          }
        }
      },
      "Conversation": {
        "type": "object",
        "properties": {
          "_id": { 
            "type": "string", 
            "example": "507f1f77bcf86cd799439012" 
          },
          "participants": {
            "type": "array",
            "items": { 
              "type": "string",
              "description": "User IDs"
            },
            "example": ["507f1f77bcf86cd799439011", "507f1f77bcf86cd799439013"]
          },
          "lastMessage": { 
            "$ref": "#/components/schemas/Message",
            "nullable": true
          },
          "unreadCount": {
            "type": "integer",
            "example": 3,
            "description": "Number of unread messages"
          },
          "updatedAt": { 
            "type": "string", 
            "format": "date-time",
            "example": "2024-01-15T14:30:00Z"
          }
        }
      },
      "Message": {
        "type": "object",
        "properties": {
          "_id": { 
            "type": "string", 
            "example": "507f1f77bcf86cd799439014" 
          },
          "conversationId": { 
            "type": "string", 
            "example": "507f1f77bcf86cd799439012" 
          },
          "senderId": { 
            "type": "string", 
            "example": "507f1f77bcf86cd799439011" 
          },
          "content": { 
            "type": "string", 
            "example": "Hello, how are you?",
            "nullable": true
          },
          "type": {
            "type": "string",
            "enum": ["text", "file", "image"],
            "example": "text"
          },
          "fileUrl": { 
            "type": "string", 
            "nullable": true, 
            "example": "https://res.cloudinary.com/xxx/file.jpg" 
          },
          "read": {
            "type": "boolean",
            "example": false,
            "description": "Message read status"
          },
          "createdAt": { 
            "type": "string", 
            "format": "date-time",
            "example": "2024-01-15T14:30:00Z"
          }
        }
      },
      "MessagesList": {
        "type": "object",
        "properties": {
          "messages": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/Message" }
          },
          "pagination": {
            "type": "object",
            "properties": {
              "currentPage": {
                "type": "integer",
                "example": 1
              },
              "totalPages": {
                "type": "integer",
                "example": 5
              },
              "totalMessages": {
                "type": "integer",
                "example": 250
              },
              "hasMore": {
                "type": "boolean",
                "example": true
              }
            }
          }
        }
      },
      "FileUploadResponse": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string",
            "example": "File uploaded successfully"
          },
          "fileUrl": { 
            "type": "string", 
            "example": "https://res.cloudinary.com/xxx/image/upload/v1234/file.jpg",
            "description": "Cloudinary URL"
          },
          "publicId": {
            "type": "string",
            "example": "chat-files/file-1234567890"
          },
          "filename": { 
            "type": "string", 
            "example": "photo.jpg" 
          },
          "size": { 
            "type": "integer", 
            "example": 1048576,
            "description": "File size in bytes"
          },
          "mimetype": { 
            "type": "string", 
            "example": "image/jpeg" 
          },
          "uploadedAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "message": { 
            "type": "string", 
            "example": "Error message" 
          },
          "error": {
            "type": "string",
            "example": "Detailed error description"
          }
        }
      },
      "SuccessResponse": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string",
            "example": "Operation successful"
          }
        }
      }
    },
    "parameters": {
      "conversationId": {
        "name": "conversationId",
        "in": "path",
        "required": true,
        "schema": { "type": "string" },
        "description": "Unique conversation identifier",
        "example": "507f1f77bcf86cd799439012"
      },
      "userId": {
        "name": "id",
        "in": "path",
        "required": true,
        "schema": { "type": "string" },
        "description": "Unique user identifier",
        "example": "507f1f77bcf86cd799439011"
      },
      "filename": {
        "name": "filename",
        "in": "path",
        "required": true,
        "schema": { "type": "string" },
        "description": "Stored filename to download",
        "example": "document-1234567890.pdf"
      }
    },
    "responses": {
      "UnauthorizedError": {
        "description": "Access token is missing or invalid",
        "content": {
          "application/json": {
            "schema": { "$ref": "#/components/schemas/ErrorResponse" },
            "example": {
              "message": "No token provided"
            }
          }
        }
      },
      "NotFoundError": {
        "description": "The specified resource was not found",
        "content": {
          "application/json": {
            "schema": { "$ref": "#/components/schemas/ErrorResponse" },
            "example": {
              "message": "User not found"
            }
          }
        }
      }
    }
  },
  "tags": [
    {
      "name": "Auth",
      "description": "Authentication endpoints for user registration and login"
    },
    {
      "name": "Users",
      "description": "User management endpoints (returns minimal user data: username & _id only)"
    },
    {
      "name": "Messages",
      "description": "Chat and conversation management endpoints"
    },
    {
      "name": "Files",
      "description": "File upload and download endpoints (Cloudinary integration)"
    }
  ],
  "paths": {
    "/auth/register": {
      "post": {
        "tags": ["Auth"],
        "summary": "Register a new user",
        "description": "Create a new user account with username, email and password",
        "operationId": "registerUser",
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/RegisterRequest" }
            }
          }
        },
        "responses": {
          "201": {
            "description": "User created successfully",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/AuthResponse" }
              }
            }
          },
          "400": {
            "description": "Bad request - validation error or user already exists",
            "content": {
              "application/json": { 
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "User already exists with this email"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } }
            }
          }
        }
      }
    },
    "/auth/login": {
      "post": {
        "tags": ["Auth"],
        "summary": "Login user",
        "description": "Authenticate user and return JWT token",
        "operationId": "loginUser",
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/LoginRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Login successful",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/AuthResponse" }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } }
            }
          }
        }
      }
    },
    "/users": {
      "get": {
        "tags": ["Users"],
        "summary": "Get all users",
        "description": "Retrieve a list of all users except current user. Returns only username and _id for privacy. Results sorted alphabetically by username.",
        "operationId": "getUsers",
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "List of users retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/UserMinimal" }
                },
                "example": [
                  { "_id": "507f1f77bcf86cd799439011", "username": "ahmed123" },
                  { "_id": "507f1f77bcf86cd799439012", "username": "sara456" }
                ]
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "500": {
            "description": "Failed to fetch users",
            "content": {
              "application/json": { 
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "Failed to fetch users",
                  "error": "Database connection error"
                }
              }
            }
          }
        }
      }
    },
    "/users/search": {
      "get": {
        "tags": ["Users"],
        "summary": "Search users by username",
        "description": "Search users by username using case-insensitive regex. Returns only username and _id. Current user excluded from results.",
        "operationId": "searchUsers",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "query",
            "in": "query",
            "required": true,
            "schema": { 
              "type": "string",
              "minLength": 1
            },
            "description": "Search query for username (case-insensitive)",
            "example": "ahmed"
          }
        ],
        "responses": {
          "200": {
            "description": "Search results",
            "content": {
              "application/json": {
                "schema": { 
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/UserMinimal" }
                },
                "example": [
                  { "_id": "507f1f77bcf86cd799439011", "username": "ahmed123" },
                  { "_id": "507f1f77bcf86cd799439013", "username": "ahmed_ali" }
                ]
              }
            }
          },
          "400": {
            "description": "Bad request - query parameter missing",
            "content": {
              "application/json": { 
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "Search query is required"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "500": {
            "description": "Search failed",
            "content": {
              "application/json": { 
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "Search failed",
                  "error": "Database error"
                }
              }
            }
          }
        }
      }
    },
    "/users/{id}": {
      "get": {
        "tags": ["Users"],
        "summary": "Get user by ID",
        "description": "Retrieve a single user by their unique identifier. Returns only username and _id for privacy. Used to display user info in chat inbox, message sender details, or profile modals.",
        "operationId": "getUserById",
        "security": [{ "BearerAuth": [] }],
        "parameters": [{ "$ref": "#/components/parameters/userId" }],
        "responses": {
          "200": {
            "description": "User found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/UserMinimal" },
                "example": {
                  "_id": "507f1f77bcf86cd799439011",
                  "username": "ahmed123"
                }
              }
            }
          },
          "404": {
            "description": "User not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "User not found"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "500": {
            "description": "Failed to fetch user",
            "content": {
              "application/json": { 
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "Failed to fetch user",
                  "error": "Database error"
                }
              }
            }
          }
        }
      }
    },
    "/messages/conversations": {
      "get": {
        "tags": ["Messages"],
        "summary": "Get all conversations",
        "description": "Retrieve all conversations for the authenticated user",
        "operationId": "getConversations",
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Conversations list retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Conversation" }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          }
        }
      }
    },
    "/messages/conversation": {
      "post": {
        "tags": ["Messages"],
        "summary": "Get or create conversation",
        "description": "Get an existing conversation or create a new one with specified participant",
        "operationId": "getOrCreateConversation",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "participantId": { 
                    "type": "string", 
                    "description": "User ID to start conversation with",
                    "example": "507f1f77bcf86cd799439011"
                  }
                },
                "required": ["participantId"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Existing conversation found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Conversation" }
              }
            }
          },
          "201": {
            "description": "New conversation created",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Conversation" }
              }
            }
          },
          "400": {
            "description": "Bad request - invalid participant data",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          }
        }
      }
    },
    "/messages/conversation/{conversationId}": {
      "delete": {
        "tags": ["Messages"],
        "summary": "Clear conversation",
        "description": "Delete all messages in a conversation (clear chat history)",
        "operationId": "clearConversation",
        "security": [{ "BearerAuth": [] }],
        "parameters": [{ "$ref": "#/components/parameters/conversationId" }],
        "responses": {
          "200": {
            "description": "Conversation cleared successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": { 
                      "type": "string", 
                      "example": "Chat cleared successfully" 
                    },
                    "deletedCount": {
                      "type": "integer",
                      "example": 25
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFoundError"
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "403": {
            "description": "Forbidden - User is not a participant",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "You are not authorized to clear this chat"
                }
              }
            }
          }
        }
      }
    },
    "/messages/{conversationId}": {
      "get": {
        "tags": ["Messages"],
        "summary": "Get conversation messages",
        "description": "Retrieve messages for a specific conversation with pagination support",
        "operationId": "getMessages",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          { "$ref": "#/components/parameters/conversationId" },
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": { 
              "type": "integer", 
              "default": 1,
              "minimum": 1
            },
            "description": "Page number"
          },
          {
            "name": "limit",
            "in": "query",
            "required": false,
            "schema": { 
              "type": "integer", 
              "default": 50,
              "minimum": 1,
              "maximum": 100
            },
            "description": "Number of messages per page"
          }
        ],
        "responses": {
          "200": {
            "description": "Messages retrieved successfully",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/MessagesList" }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFoundError"
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "403": {
            "description": "Forbidden - User is not a participant",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "You are not authorized to view this conversation"
                }
              }
            }
          }
        }
      }
    },
    "/file/upload": {
      "post": {
        "tags": ["Files"],
        "summary": "Upload file to Cloudinary",
        "description": "Upload a file (images, documents, or videos) to Cloudinary. Rate limited to 10 uploads per 15 minutes.",
        "operationId": "uploadFile",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "description": "File to upload"
                  }
                },
                "required": ["file"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "File uploaded successfully",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/FileUploadResponse" }
              }
            }
          },
          "400": {
            "description": "No file uploaded or invalid file type",
            "content": {
              "application/json": { 
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "No file uploaded"
                }
              }
            }
          },
          "413": {
            "description": "File size exceeds limit",
            "content": {
              "application/json": { 
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "File size exceeds maximum allowed size"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": { 
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "Too many file uploads, please try again after 15 minutes"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          }
        }
      }
    },
    "/file/get/{filename}": {
      "get": {
        "tags": ["Files"],
        "summary": "Download file from Cloudinary",
        "description": "Download a previously uploaded file. Rate limited to 50 downloads per 15 minutes.",
        "operationId": "downloadFile",
        "security": [{ "BearerAuth": [] }],
        "parameters": [{ "$ref": "#/components/parameters/filename" }],
        "responses": {
          "200": {
            "description": "File retrieved successfully",
            "content": {
              "application/octet-stream": {
                "schema": { 
                  "type": "string", 
                  "format": "binary" 
                }
              },
              "image/jpeg": {
                "schema": { 
                  "type": "string", 
                  "format": "binary" 
                }
              },
              "image/png": {
                "schema": { 
                  "type": "string", 
                  "format": "binary" 
                }
              },
              "application/pdf": {
                "schema": { 
                  "type": "string", 
                  "format": "binary" 
                }
              }
            }
          },
          "404": {
            "description": "File not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "File not found"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": { 
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "message": "Too many file downloads, please try again after 15 minutes"
                }
              }
            }
          }
        }
      }
    }
  }
}